{"version":3,"sources":["../../server/controllers/usercontroller.js"],"names":["dotenv","config","genID","Math","floor","random","controller","postSignUp","req","res","helper","validEmail","body","EmailAddress","valid","bcrypt","genSalt","err","salt","hash","Password","error","text","values","FirstName","LastName","Sex","DOB","PhoneNumber","client","query","error1","result","status","json","message","token","jwt","sign","userId","rows","ID","process","env","KEY","expiresIn","response","data","MobileNumber","RidesTaken","RidesOffered","Friends","e","postLogIn","sql","length","compare","same","deleteTestUser","email","callback"],"mappings":"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","file":"usercontroller.js","sourcesContent":["import dotenv from 'dotenv';\r\nimport jwt from 'jsonwebtoken';\r\nimport bcrypt from 'bcrypt';\r\nimport helper from '../helpers/helper';\r\nimport client from '../model/db';\r\n\r\ndotenv.config();\r\n\r\nconst genID = () => `U_${Math.floor(Math.random() * 9000000000) + 1000000000}`; //  Got this from a web source I can't remember now.\r\nconst controller = {\r\n  postSignUp: (req, res) => {\r\n    helper.validEmail(req.body.EmailAddress, (valid) => {\r\n      try {\r\n        if (valid) {\r\n          bcrypt.genSalt(10, (err, salt) => {\r\n            if (err) {\r\n              throw err;\r\n            }\r\n            bcrypt.hash(req.body.Password, salt, (error, hash) => {\r\n              if (err) {\r\n                throw err;\r\n              }\r\n              const text = 'INSERT INTO public.\"Users\" (\"ID\", \"FirstName\", \"LastName\", \"Sex\", \"DOB\", \"MobileNumber\", \"EmailAddress\", \"Password\", \"RidesOffered\", \"RidesTaken\", \"Friends\") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11) RETURNING *;';\r\n              const values = [genID(), req.body.FirstName, req.body.LastName, req.body.Sex, req.body.DOB, req.body.PhoneNumber, req.body.EmailAddress, hash, 0, 0, 0];\r\n              client.query(text, values, (error1, result) => {\r\n                if (error1) {\r\n                  res.status(400);\r\n                  res.json({\r\n                    status: 'fail',\r\n                    message: 'Could not add user to database',\r\n                  });\r\n                } else {\r\n                  const token = jwt.sign(\r\n                    {\r\n                      userId: result.rows[0].ID,\r\n                    },\r\n                    process.env.KEY,\r\n                    {\r\n                      expiresIn: '1h',\r\n                    }\r\n                  );\r\n                  const response = {\r\n                    status: 'Success',\r\n                    data: {\r\n                      token,\r\n                      ID: result.rows[0].ID,\r\n                      FirstName: result.rows[0].FirstName,\r\n                      LastName: result.rows[0].LastName,\r\n                      MobileNumber: result.rows[0].MobileNumber,\r\n                      EmailAddress: result.rows[0].EmailAddress,\r\n                      RidesTaken: result.rows[0].RidesTaken,\r\n                      RidesOffered: result.rows[0].RidesOffered,\r\n                      Friends: result.rows[0].Friends,\r\n                    },\r\n                  };\r\n                  res.json(response);\r\n                }\r\n              });\r\n            });\r\n          });\r\n        } else {\r\n          res.status(400);\r\n          res.json({\r\n            status: 'fail',\r\n            message: 'Could not add user to database',\r\n          });\r\n        }\r\n      } catch (e) {\r\n        res.status(400);\r\n        res.json({\r\n          status: 'fail',\r\n          message: 'Could not add user to database',\r\n        });\r\n      }\r\n    });\r\n  },\r\n  postLogIn: (req, res) => {\r\n    try {\r\n      const sql = `SELECT * FROM public.\"Users\" WHERE \"EmailAddress\" = '${req.body.EmailAddress}'`;\r\n      client.query(sql, (err, result) => {\r\n        if (err || result.rows.length === 0) {\r\n          res.status(401);\r\n          res.json({\r\n            status: 'fail',\r\n            message: 'Unauthorized',\r\n          });\r\n        } else {\r\n          bcrypt.compare(req.body.Password, result.rows[0].Password, (error, same) => {\r\n            if (error || !same) {\r\n              res.status(401);\r\n              res.json({\r\n                status: 'fail',\r\n                message: 'Unauthorized',\r\n              });\r\n            } else {\r\n              const token = jwt.sign(\r\n                {\r\n                  userId: result.rows[0].ID,\r\n                },\r\n                process.env.KEY,\r\n                {\r\n                  expiresIn: '1h',\r\n                }\r\n              );\r\n              const response = {\r\n                status: 'success',\r\n                data: {\r\n                  token,\r\n                  ID: result.rows[0].ID,\r\n                  FirstName: result.rows[0].FirstName,\r\n                  LastName: result.rows[0].LastName,\r\n                  MobileNumber: result.rows[0].MobileNumber,\r\n                  EmailAddress: result.rows[0].EmailAddress,\r\n                  RidesTaken: result.rows[0].RidesTaken,\r\n                  RidesOffered: result.rows[0].RidesOffered,\r\n                  Friends: result.rows[0].Friends,\r\n                }\r\n              };\r\n              res.json(response);\r\n            }\r\n          });\r\n        }\r\n      });\r\n    } catch (e) {\r\n      res.status(401);\r\n      res.json({\r\n        status: 'fail',\r\n        message: 'Unauthorized',\r\n      });\r\n    }\r\n  },\r\n  deleteTestUser: (email, callback) => {\r\n    helper.validEmail(email, (response) => {\r\n      if (response) {\r\n        const sql = `DELETE FROM public.\"Users\" WHERE \"EmailAddress\" = '${email}'`;\r\n        client.query(sql, () => {\r\n          callback();\r\n        });\r\n      } else {\r\n        callback();\r\n      }\r\n    });\r\n  },\r\n};\r\n\r\nexport default controller;\r\n"]}